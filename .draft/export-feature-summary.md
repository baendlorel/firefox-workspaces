# 导入导出功能改造总结

## 改动概述

根据需求，已完成导入导出功能的改造，移除了 hash 校验和压缩功能，并新增了加密工作区的密码验证界面。

## 主要改动

### 1. 类型定义更新

**文件**: `src/types/storage.d.ts`

- 将 `ExportData` 从 `interface` 改为 `type`，直接使用 `Persist` 类型
- 移除了 `hash` 字段

### 2. 导出逻辑修改

**文件**: `src/web/popup.service.ts`

- `exportData()` 方法不再直接导出 JSON
- 改为打开导出页面（`PopupPage.Export`）
- 由导出页面处理密码验证和文件生成

**文件**: `src/lib/consts.ts`

- 在 `PopupPage` 枚举中新增 `Export = 'export'`

### 3. 导入逻辑修改

**文件**: `src/manager.ts`

- `importData()` 方法移除了 hash 校验逻辑
- 直接验证数据结构的有效性
- 保留了工作区合并逻辑（只新增不覆盖）和设置覆盖逻辑

### 4. 新增导出页面

**文件**: `pages/export.html`

- 参照项目风格设计的导出界面
- 包含密码表单区域（有加密工作区时显示）
- 状态消息区域用于显示导出进度和结果

**文件**: `pages/export.ts`

- 检测并列出所有加密的工作区
- 为每个加密工作区生成密码输入框
- 显示密码提示（前3位明文）
- 验证所有密码是否正确（SHA-256 哈希对比）
- 密码错误时：
  - 输入框显示红色边框和阴影
  - 显示错误数量
  - 保持页面打开让用户重试
- 密码全部正确时：
  - 生成 JSON 文件并下载
  - 1.5 秒后自动关闭页面

### 5. 国际化支持

**文件**: `_locales/en/messages.json` 和 `_locales/zh_CN/messages.json`

- 新增导出页面相关的翻译文本：
  - `dialog.export.title`: 导出页面标题
  - `dialog.export.intro`: 导出页面介绍
  - `dialog.export.password-required`: 密码要求提示
  - `dialog.export.export`: 导出按钮文本

### 6. 兼容性修复

**文件**: `src/lib/compress.ts`

- 更新字段顺序数组以匹配新的 `Persist` 类型
- 移除了 `hash` 字段
- 添加了密码相关字段（`password`, `passpeek`, `lockUntil`, `failedAttempts`）

## 功能特性

### 导出功能

1. ✅ 不再需要 hash 校验
2. ✅ 不再需要压缩
3. ✅ 导出为纯 JSON 格式
4. ✅ 加密工作区需要输入密码
5. ✅ 密码错误时红色边框提示
6. ✅ 支持重试（页面不关闭）
7. ✅ 全部正确后自动下载并关闭

### 导入功能

1. ✅ 移除 hash 校验
2. ✅ 直接导入 JSON 数据
3. ✅ 保留数据验证功能
4. ✅ 工作区只新增不覆盖
5. ✅ 设置覆盖导入

## 用户体验流程

### 无加密工作区

1. 点击导出
2. 直接下载 JSON 文件
3. 页面自动关闭

### 有加密工作区

1. 点击导出
2. 显示密码表单
3. 输入所有加密工作区的密码
4. 点击导出按钮
5. 验证密码：
   - 全部正确 → 下载文件 → 自动关闭
   - 有错误 → 标红错误项 → 提示重试
6. 修改错误密码后重新点击导出

## 样式设计

- 遵循项目统一的视觉风格
- 渐变背景（绿色到蓝色）
- 卡片式布局
- 平滑的动画过渡
- 错误时的抖动动画效果
- 响应式设计

## 技术亮点

1. **密码安全**: 使用 SHA-256 哈希验证，不传输明文密码
2. **用户友好**: 提供密码提示（前3位），方便用户回忆
3. **错误处理**: 清晰的错误反馈和重试机制
4. **类型安全**: 完整的 TypeScript 类型定义
5. **国际化**: 支持中英文双语

## 测试建议

1. 测试无加密工作区的导出
2. 测试单个加密工作区的导出
3. 测试多个加密工作区的导出
4. 测试密码错误的情况
5. 测试部分密码正确部分错误的情况
6. 测试导入导出的完整流程
